<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
    // Дані PRICE_THRESHOLDS із price_finder.py
    const PRICE_THRESHOLDS = {
        'premium': 450,
        'rlc': 1600,
        'super_treasure_hunt': 1000,
        'diorama': 800,
        'matchbox': 110,
        'treasure_hunts': 110,
        'team_transport': 650,
        'mainline': 110
    };

    // Виведення інформації про мінімальні ціни
    function displayPriceInfo() {
        const priceInfoDiv = document.getElementById('priceInfo');
        priceInfoDiv.innerHTML = `
            <p><strong>Мінімальна ціна на:</strong></p>
            <p>Mainline - ${PRICE_THRESHOLDS.mainline} грн</p>
            <p>Premium - ${PRICE_THRESHOLDS.premium} грн</p>
        `;
    }

    // Виклик функції для відображення цін
    displayPriceInfo();

    function searchCar() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().replace(/"/g, '');
        const resultDiv = document.getElementById('result');
        const placeholderDiv = document.getElementById('placeholder');

        // Ховаємо заглушку і показуємо результати
        placeholderDiv.style.display = 'none';
        resultDiv.style.display = 'block';

        if (!searchTerm) {
            resultDiv.innerHTML = '<div class="warning">Будь ласка, введіть назву машинки для пошуку!</div>';
            return;
        }
        console.log('Search triggered for:', searchTerm);
        resultDiv.innerHTML = 'Завантаження...';

        Papa.parse('https://raw.githubusercontent.com/shady333/PriceParserRETRO/main/car_prices.csv', {
            download: true,
            header: true,
            complete: function(results) {
                console.log('CSV data loaded:', results.data);
                const data = results.data;
                const matches = data.filter(row => 
                    row.car_name && row.car_name.toLowerCase().replace(/"/g, '').includes(searchTerm)
                );

                if (matches.length > 0) {
                    let output = '<h3>Знайдені машинки:</h3><div class="table-wrapper"><table><tr><th>Зображення</th><th>Назва</th><th>Остання ціна (грн)</th><th>Дата</th></tr>';
                    matches.forEach(match => {
                        let lastPrice = null;
                        let lastDate = null;
                        for (const key in match) {
                            if (key !== 'category' && key !== 'car_name' && match[key] && !isNaN(match[key])) {
                                if (!lastDate || key > lastDate) {
                                    lastPrice = parseFloat(match[key]);
                                    lastDate = key;
                                }
                            }
                        }
                        const imageUrl = match.image_url || 'https://via.placeholder.com/150';

                        // Перевірка різниці в днях
                        const currentDate = new Date();
                        const lastDateObj = new Date(lastDate);
                        const diffDays = Math.floor((currentDate - lastDateObj) / (1000 * 60 * 60 * 24));

                        // Не показувати, якщо немає ціни за останні 10 днів
                        if (!lastDate || diffDays > 10) {
                            return; // Пропускаємо цей рядок
                        }

                        // Підсвітка або червоний текст, якщо різниця > 3 дні
                        let rowClass = diffDays > 3 ? 'warning' : '';
                        output += `<tr class="${rowClass}"><td><img src="${imageUrl}" alt="Зображення ${match.car_name}"></td><td>${match.car_name}</td><td>${lastPrice || 'N/A'}</td><td>${lastDate || 'N/A'}</td></tr>`;
                    });
                    output += '</table></div>';

                    // Перевіряємо, чи залишилися рядки після фільтрації
                    if (output.includes('<tr')) {
                        if (matches.length === 1) {
                            const pricesWithDates = [];
                            for (const key in matches[0]) {
                                if (key !== 'category' && key !== 'car_name' && matches[0][key] && !isNaN(matches[0][key])) {
                                    pricesWithDates.push({ date: key, price: parseFloat(matches[0][key]) });
                                }
                            }
                            if (pricesWithDates.length > 0) {
                                const lastPriceEntry = pricesWithDates.reduce((max, current) => max.date > current.date ? max : current);
                                const minPriceEntry = pricesWithDates.reduce((min, current) => min.price < current.price ? min : current);
                                const maxPriceEntry = pricesWithDates.reduce((max, current) => max.price > current.price ? max : current);

                                output += `
                                    <p><strong>Остання ціна:</strong> ${lastPriceEntry.price} грн (дата: ${lastPriceEntry.date})</p>
                                    <p><strong>Мінімальна ціна:</strong> ${minPriceEntry.price} грн (дата: ${minPriceEntry.date})</p>
                                    <p><strong>Максимальна ціна:</strong> ${maxPriceEntry.price} грн (дата: ${maxPriceEntry.date})</p>
                                `;
                            } else {
                                output += '<p>Немає даних для мінімальної та максимальної цін.</p>';
                            }
                        }
                        resultDiv.innerHTML = output;
                    } else {
                        resultDiv.innerHTML = 'Машинку не знайдено або дані застарілі (більше 10 днів).';
                    }
                } else {
                    resultDiv.innerHTML = 'Машинку не знайдено';
                }
            },
            error: function(error) {
                console.error('Error loading CSV:', error);
                resultDiv.innerHTML = 'Помилка завантаження CSV: ' + error.message;
            }
        });
    }

    // Повернення заглушки при очищенні поля вводу
    document.getElementById('searchInput').addEventListener('input', function(event) {
        if (!event.target.value) {
            document.getElementById('result').style.display = 'none';
            document.getElementById('placeholder').style.display = 'flex';
        }
    });

    document.getElementById('searchButton').addEventListener('click', searchCar);
    document.getElementById('searchButton').addEventListener('touchstart', searchCar);
    document.getElementById('searchInput').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            searchCar();
        }
    });
</script>
