<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü—ñ–Ω Hot Wheels</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 8px 12px; cursor: pointer; }
    select { padding: 6px; margin-left:10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; }
    img { max-width: 60px; }
    .note { font-size: 14px; color: #555; margin-top:5px; margin-bottom:5px; }
  </style>
</head>
<body>
  <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É–ø—ñ–≤–µ–ª—å–Ω–∏—Ö —Ü—ñ–Ω Hot Wheels</h1>

  <div>
    –ö–∞—Ç–µ–≥–æ—Ä—ñ—è:
    <select id="categoryFilter">
      <option value="All">–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
    </select>
  </div>

  <div style="margin-top:10px;">
    <button onclick="showTopGrowth()">–¢–æ–ø-10 –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è —Ü—ñ–Ω–∏</button>
    <button onclick="showTopDrop()">–¢–æ–ø-10 –ø–∞–¥—ñ–Ω–Ω—è —Ü—ñ–Ω–∏</button>
    <button onclick="showStopped()">–¢–æ–ø-10 –∑–Ω–∏–∫–ª—ñ</button>
    <button onclick="showNew()">–¢–æ–ø-10 –Ω–æ–≤—ñ</button>
    <button onclick="showExpensive()">–¢–æ–ø-10 –Ω–∞–π–¥–æ—Ä–æ–∂—á–∏—Ö</button>
    <button onclick="showCheap()">–¢–æ–ø-10 –Ω–∞–π–¥–µ—à–µ–≤—à–∏—Ö</button>
    <button onclick="showVolatile()">–¢–æ–ø-10 –≤–æ–ª–∞—Ç–∏–ª—å–Ω–∏—Ö</button>
    <button onclick="showStable()">–¢–æ–ø-10 —Å—Ç–∞–±—ñ–ª—å–Ω–∏—Ö</button>
  </div>

  <div id="note" class="note"></div>
  <div id="output"></div>

  <script>
    const buyCsvUrl = 'https://raw.githubusercontent.com/shady333/PriceParserRETRO/main/car_prices.csv';
    let cars = [];
    let dateColumns = [];

    Papa.parse(buyCsvUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        const columns = results.meta.fields;
        dateColumns = columns.slice(3); // –∑ 4-—ó –∫–æ–ª–æ–Ω–∫–∏ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –¥–∞—Ç–∏

        // –û—Ç—Ä–∏–º—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
        const categories = Array.from(new Set(data.map(r => r.category).filter(Boolean))).sort();
        const catSel = document.getElementById('categoryFilter');
        categories.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          catSel.appendChild(opt);
        });

        cars = data.map(row => {
          const prices = dateColumns.map(d => parseFloat(row[d]) || null);
          return {
            category: row.category,
            name: row.car_name,
            image: row.image_url,
            prices: prices
          };
        });

        console.log("‚úÖ –î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:", cars);
      }
    });

    function getFilteredCars() {
      const cat = document.getElementById('categoryFilter').value;
      if(cat === 'All') return cars;
      return cars.filter(c => c.category === cat);
    }

    function getLastPrice(prices) {
      for (let i = prices.length - 1; i >= 0; i--) {
        if (prices[i] !== null) return { price: prices[i], date: dateColumns[i] };
      }
      return { price: null, date: null };
    }

    function getFirstPrice(prices) {
      for (let i = 0; i < prices.length; i++) {
        if (prices[i] !== null) return { price: prices[i], date: dateColumns[i] };
      }
      return { price: null, date: null };
    }

    function showTable(list, title, extraNote="") {
      let html = `<h2>${title}</h2>`;
      if(extraNote) html += `<div class="note">${extraNote}</div>`;
      html += `<table><tr>
        <th>–ö–∞—Ä—Ç–∏–Ω–∫–∞</th><th>–ù–∞–∑–≤–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th>–ü–æ—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞</th><th>–î–æ–¥–∞—Ç–∫–æ–≤–æ</th>
      </tr>`;
      list.forEach(c => {
        html += `<tr>
          <td><img src="${c.image || ''}"></td>
          <td>${c.name}</td>
          <td>${c.category}</td>
          <td>${c.last?.price ?? '-'}</td>
          <td>${c.metric ?? ''}</td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("output").innerHTML = html;
    }

    function showTopGrowth() {
      const list = getFilteredCars().map(c => {
        const first = getFirstPrice(c.prices);
        const last = getLastPrice(c.prices);
        const diff = (first.price && last.price) ? last.price - first.price : 0;
        return { ...c, last, metric: diff > 0 ? `+${diff.toFixed(2)}` : null, diff };
      }).filter(c => c.diff > 0).sort((a,b) => b.diff - a.diff).slice(0,10);
      showTable(list, "–¢–æ–ø-10 –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è —Ü—ñ–Ω–∏");
    }

    function showTopDrop() {
      const list = getFilteredCars().map(c => {
        const first = getFirstPrice(c.prices);
        const last = getLastPrice(c.prices);
        const diff = (first.price && last.price) ? last.price - first.price : 0;
        return { ...c, last, metric: diff < 0 ? diff.toFixed(2) : null, diff };
      }).filter(c => c.diff < 0).sort((a,b) => a.diff - b.diff).slice(0,10);
      showTable(list, "–¢–æ–ø-10 –ø–∞–¥—ñ–Ω–Ω—è —Ü—ñ–Ω–∏");
    }

    function showStopped() {
      const list = getFilteredCars().filter(c => {
        const last5 = c.prices.slice(-5);
        return last5.every(v => v === null) && getLastPrice(c.prices).price !== null;
      }).map(c => {
        const last = getLastPrice(c.prices);
        return { ...c, last, metric: `–û—Å—Ç–∞–Ω–Ω—è —Ü—ñ–Ω–∞: ${last.price} (${last.date})` };
      }).slice(0,10);
      showTable(list, "–¢–æ–ø-10 –∑–Ω–∏–∫–ª—ñ –º–æ–¥–µ–ª—ñ");
    }

    function showNew() {
      const list = getFilteredCars().filter(c => {
        const last3 = c.prices.slice(-3);
        const before = c.prices.slice(0,-3);
        return last3.some(v => v !== null) && before.every(v => v === null);
      }).map(c => {
        const first = getFirstPrice(c.prices);
        return { ...c, last: getLastPrice(c.prices), metric: `–ü–µ—Ä—à–∞ —Ü—ñ–Ω–∞: ${first.price} (${first.date})` };
      }).slice(0,10);
      showTable(list, "–¢–æ–ø-10 –Ω–æ–≤—ñ –º–æ–¥–µ–ª—ñ");
    }

    function showExpensive() {
      const list = getFilteredCars().map(c => {
        const last = getLastPrice(c.prices);
        return { ...c, last, metric: last.price };
      }).filter(c => c.last?.price !== null)
        .sort((a,b) => b.last.price - a.last.price).slice(0,10);
      showTable(list, "–¢–æ–ø-10 –Ω–∞–π–¥–æ—Ä–æ–∂—á–∏—Ö");
    }

    function showCheap() {
      const list = getFilteredCars().map(c => {
        const last = getLastPrice(c.prices);
        return { ...c, last, metric: last.price };
      }).filter(c => c.last?.price !== null)
        .sort((a,b) => a.last.price - b.last.price).slice(0,10);
      showTable(list, "–¢–æ–ø-10 –Ω–∞–π–¥–µ—à–µ–≤—à–∏—Ö");
    }

    function showVolatile() {
      const list = getFilteredCars().map(c => {
        const values = c.prices.filter(v=>v!==null);
        if(values.length < 2) return null;
        const last = getLastPrice(c.prices);
        const min = Math.min(...values);
        const max = Math.max(...values);
        return {...c, last, metric: `–î—ñ–∞–ø–∞–∑–æ–Ω: ${min} ‚Äì ${max}`};
      }).filter(Boolean).sort((a,b)=> (Math.max(...b.prices.filter(v=>v!==null)) - Math.min(...b.prices.filter(v=>v!==null))) -
                                     (Math.max(...a.prices.filter(v=>v!==null)) - Math.min(...a.prices.filter(v=>v!==null)))).slice(0,10);
      showTable(list, "–¢–æ–ø-10 –≤–æ–ª–∞—Ç–∏–ª—å–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π", "–í–æ–ª–∞—Ç–∏–ª—å–Ω—ñ—Å—Ç—å = —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—é —Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—é —Ü—ñ–Ω–æ—é –∑–∞ –ø–µ—Ä—ñ–æ–¥");
    }

    function showStable() {
      const list = getFilteredCars().map(c => {
        const values = c.prices.filter(v=>v!==null);
        if(values.length < 2) return null;
        const last = getLastPrice(c.prices);
        const min = Math.min(...values);
        const max = Math.max(...values);
        return {...c, last, metric: `–î—ñ–∞–ø–∞–∑–æ–Ω: ${min} ‚Äì ${max}`};
      }).filter(Boolean).sort((a,b)=> (Math.max(...a.prices.filter(v=>v!==null)) - Math.min(...a.prices.filter(v=>v!==null))) -
                                     (Math.max(...b.prices.filter(v=>v!==null)) - Math.min(...b.prices.filter(v=>v!==null)))).slice(0,10);
      showTable(list, "–¢–æ–ø-10 —Å—Ç–∞–±—ñ–ª—å–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π", "–°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å = –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ —Ü—ñ–Ω–∞–º–∏ –∑–∞ –ø–µ—Ä—ñ–æ–¥");
    }
  </script>
</body>
</html>
